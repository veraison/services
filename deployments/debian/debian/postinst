#!/bin/sh

if [ "$1" = "configure" ]; then
	[ -z "$VERAISON_USER" ] && VERAISON_USER=veraison
	[ -z "$VERAISON_GROUP" ] && VERAISON_GROUP=veraison

	if [ ! "$(getent group "$VERAISON_GROUP")" ]; then
		groupadd --system "$VERAISON_GROUP"
	else
		echo "Group $VERAISON_GROUP already exists."
	fi

	if [ ! "$(getent passwd setrofim)" ]; then
		useradd --system --gid "$VERAISON_GROUP" --no-create-home \
			--shell /bin/false "$VERAISON_USER"
	else
		echo "User $VERAISON_USER already exists."
	fi

	chown -R "$VERAISON_USER":"$VERAISON_GROUP" /opt/veraison/logs
	chown -R "$VERAISON_USER":"$VERAISON_GROUP" /opt/veraison/signing
	chown -R "$VERAISON_USER":"$VERAISON_GROUP" /opt/veraison/certs
	chown -R "$VERAISON_USER":"$VERAISON_GROUP" /opt/veraison/stores

	chmod 0500 /opt/veraison/certs/*.key

	# Generate installation metadata
	METADATA_FILE="/usr/share/veraison/installation.json"
	METADATA_DIR="$(dirname "$METADATA_FILE")"
	VERSION="$(dpkg-query -W -f='${Version}' veraison 2>/dev/null || echo 'unknown')"
	INSTALL_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
	ARCH="$(dpkg --print-architecture)"

	mkdir -p "$METADATA_DIR"

	cat > "$METADATA_FILE" <<EOF
{
  "version": "${VERSION}",
  "deployment_method": "deb",
  "install_time": "${INSTALL_TIME}",
  "metadata": {
    "package": "veraison",
    "architecture": "${ARCH}"
  }
}
EOF

	chmod 644 "$METADATA_FILE"

	/opt/veraison/bin/veraison -s start-services
fi
